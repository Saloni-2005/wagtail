{% load navigation_tags wagtailimages_tags %}

{% if menu_items %}
<ul class="navigation-menu">
    {% for item in menu_items %}
    {% get_menu item.slug item.page request.user.is_authenticated as submenu %}
    <li class="{% if submenu %}has-children{% endif %}">
        <a href="{{ item.url }}" {% if item.open_in_new_tab %} target="_blank" rel="noopener" {% endif %}>
            {% if item.icon %}
                {% comment %}Render icon with error handling{% endcomment %}
                {% with item.icon as menu_icon %}
                    {% if menu_icon.file %}
                        {% image menu_icon fill-20x20 class="menu-icon" alt="{{ item.title }} icon" %}
                    {% else %}
                        {% comment %}Fallback for broken image references{% endcomment %}
                        <span class="menu-icon menu-icon-placeholder" title="Icon not available">ðŸ“„</span>
                    {% endif %}
                {% endwith %}
            {% endif %}
            <span class="menu-text">{{ item.title }}</span>
        </a>
        {% if submenu %}
        <ul class="children">
            {% for subitem in submenu %}
            <li>
                <a href="{{ subitem.url }}" {% if subitem.open_in_new_tab %} target="_blank" rel="noopener" {% endif %}>
                    {% if subitem.icon %}
                        {% with subitem.icon as submenu_icon %}
                            {% if submenu_icon.file %}
                                {% image submenu_icon fill-16x16 class="menu-icon" alt="{{ subitem.title }} icon" %}
                            {% else %}
                                <span class="menu-icon menu-icon-placeholder" title="Icon not available">ðŸ“„</span>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                    <span class="menu-text">{{ subitem.title }}</span>
                </a>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% endif %}